name: Build Multi-Platform Releases

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

env:
  FLUTTER_VERSION: "stable"

jobs:
  # ---------- ANDROID (APK) ----------
  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CONTENT_REPO_TOKEN }}
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Android APK (release)
        env:
          AUTH_CANARY_SALT: ${{ secrets.AUTH_CANARY_SALT }}
          AUTH_CANARY_NONCE: ${{ secrets.AUTH_CANARY_NONCE }}
          AUTH_CANARY_DATA: ${{ secrets.AUTH_CANARY_DATA }}
          AUTH_CANARY_MAC: ${{ secrets.AUTH_CANARY_MAC }}
        run: flutter build apk --release

      - name: Archive APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  # ---------- LINUX ----------
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CONTENT_REPO_TOKEN }}
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install Linux build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Linux (release)
        env:
          AUTH_CANARY_SALT: ${{ secrets.AUTH_CANARY_SALT }}
          AUTH_CANARY_NONCE: ${{ secrets.AUTH_CANARY_NONCE }}
          AUTH_CANARY_DATA: ${{ secrets.AUTH_CANARY_DATA }}
          AUTH_CANARY_MAC: ${{ secrets.AUTH_CANARY_MAC }}
        run: flutter build linux --release

      - name: Archive Linux bundle
        run: |
          cd build/linux/x64/release
          tar -czf linux-bundle.tar.gz bundle
          mv linux-bundle.tar.gz $GITHUB_WORKSPACE/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: linux-bundle.tar.gz

  # ---------- WINDOWS ----------
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CONTENT_REPO_TOKEN }}
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Windows (release)
        shell: bash
        env:
          AUTH_CANARY_SALT: ${{ secrets.AUTH_CANARY_SALT }}
          AUTH_CANARY_NONCE: ${{ secrets.AUTH_CANARY_NONCE }}
          AUTH_CANARY_DATA: ${{ secrets.AUTH_CANARY_DATA }}
          AUTH_CANARY_MAC: ${{ secrets.AUTH_CANARY_MAC }}
        run: flutter build windows --release

      - name: Zip Windows bundle
        shell: bash
        run: |
          cd build/windows/x64/runner/Release
          7z a windows-bundle.zip *
          mv windows-bundle.zip $GITHUB_WORKSPACE/

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundle
          path: windows-bundle.zip

  # ---------- (Optional) macOS ----------
  # macos:
  #   runs-on: macos-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #        with:
  #          token: ${{ secrets.CONTENT_REPO_TOKEN }}
  #          submodules: recursive
  #          fetch-depth: 0
  #          persist-credentials: false
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         channel: ${{ env.FLUTTER_VERSION }}
  #         cache: true
  #     - name: Flutter pub get
  #       run: flutter pub get
  #     - name: Build macOS (release)
  #       run: flutter build macos --release
  #     - name: Zip macOS app
  #       run: |
  #         cd build/macos/Build/Products/Release
  #         zip -r macos-app.zip *.app
  #         mv macos-app.zip $GITHUB_WORKSPACE/
  #     - name: Upload macOS artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-app
  #         path: macos-app.zip

  # ---------- CREATE GITHUB RELEASE WITH ARTIFACTS ----------
  release:
    needs: [android, linux, windows] # add 'macos' if enabling that job
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts
      - uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: artifacts
      - uses: actions/download-artifact@v4
        with:
          name: windows-bundle
          path: artifacts
      # - uses: actions/download-artifact@v4
      #   with:
      #     name: macos-app
      #     path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          files: |
            artifacts/app-release.apk
            artifacts/linux-bundle.tar.gz
            artifacts/windows-bundle.zip
            # artifacts/macos-app.zip
